<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- PWA Manifest & Mobile Home Screen Meta -->
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lever Action EPUB Reader</title>
  <!-- Inline script to immediately set dark mode if stored -->
  <script>
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    }
  </script>
  <!-- Google Font: Roboto -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <style>
    /* -------------------------- */
    /* Global Variables & Styles  */
    /* -------------------------- */
    :root {
      --bg-color-light: #f5f7fa;
      --text-color-light: #333;
      --red-primary: #ff0000;
      --red-secondary: #ff4d4d;
      --bg-color-dark: #1e1e1e;
      --text-color-dark: #f5f5f5;
      --sidebar-width: 200px;
      --sidebar-collapsed-width: 40px;
    }
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-color-light);
      color: var(--text-color-light);
      overflow: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    html.dark, body.dark {
      background-color: var(--bg-color-dark);
      color: var(--text-color-dark);
    }
    
    /* -------------------------- */
    /* Library View Styles        */
    /* -------------------------- */
    #library {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow-y: auto;
      padding: 20px;
      background: var(--bg-color-light);
    }
    html.dark #library {
      background: var(--bg-color-dark);
    }
    #library h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    #libraryList {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .book-item {
      cursor: pointer;
      width: 150px;
      text-align: center;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 4px;
      background: #fff;
      transition: transform 0.2s;
    }
    .book-item:hover {
      transform: scale(1.05);
    }
    .book-item img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      margin-bottom: 10px;
      object-fit: cover;
      max-height: 200px;
    }
    
    /* -------------------------- */
    /* Desktop Sidebar (UI Tab)   */
    /* -------------------------- */
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: var(--sidebar-width);
      background: linear-gradient(180deg, var(--red-primary), var(--red-secondary));
      color: #fff;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: width 0.3s ease;
      z-index: 1100;
    }
    #sidebar.retracted {
      width: var(--sidebar-collapsed-width);
    }
    #sidebar button,
    #sidebar label {
      background: rgba(255,255,255,0.2);
      border: none;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      margin: 5px 0;
      width: 100%;
      text-align: center;
      transition: background 0.3s ease;
    }
    #sidebar button:hover,
    #sidebar label:hover {
      background: rgba(255,255,255,0.3);
    }
    #sidebar input[type="file"] {
      display: none;
    }
    /* Sidebar toggle button */
    #sidebar #sidebarToggle {
      background: transparent;
      width: auto;
      align-self: flex-end;
      margin-bottom: 10px;
    }
    /* Hide controls when sidebar is retracted */
    #sidebar.retracted #sidebarContent {
      display: none;
    }
    
    /* -------------------------- */
    /* Reader Styles              */
    /* -------------------------- */
    #reader {
      position: absolute;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      bottom: 0;
      overflow: auto;
      background: #fff;
      transition: left 0.3s ease;
      font-size: 16px;
    }
    /* If dark mode, force dark background immediately */
    html.dark #reader {
      background: var(--bg-color-dark);
    }
    #reader.hidden {
      display: none;
    }
    /* One-page mode centering */
    #reader.one-page {
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    #reader.one-page iframe,
    #reader.one-page .epub-view {
      width: 600px;
      height: 800px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      transform-origin: center center;
    }
    /* Adjust reader offset if sidebar is retracted */
    #sidebar.retracted ~ #reader {
      left: var(--sidebar-collapsed-width);
    }
    
    /* -------------------------- */
    /* TOC Sidebar                */
    /* -------------------------- */
    #toc {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 250px;
      background: #fff;
      color: #333;
      overflow-y: auto;
      padding: 15px;
      z-index: 1050;
      box-shadow: -2px 0 8px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      transform: translateX(100%);
    }
    html.dark #toc {
      background: var(--bg-color-dark);
      color: var(--text-color-dark);
    }
    #toc.visible {
      transform: translateX(0);
    }
    #toc ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #toc li {
      margin-bottom: 12px;
    }
    #toc a {
      text-decoration: none;
      color: inherit;
      font-weight: 500;
      transition: color 0.2s ease;
    }
    #toc a:hover {
      color: var(--red-secondary);
    }
    
    /* -------------------------- */
    /* Bookmark Manager           */
    /* -------------------------- */
    #bookmarkManager {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1300;
    }
    #bookmarkManager .content {
      background: #fff;
      color: #333;
      padding: 20px;
      border-radius: 4px;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    html.dark #bookmarkManager .content {
      background: #2e2e2e;
      color: #fff;
      box-shadow: 0 0 15px rgba(255,255,255,0.2);
    }
    #bookmarkManager h2 {
      margin-top: 0;
    }
    .bookmark-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ccc;
      padding: 5px 0;
    }
    .bookmark-item:last-child {
      border-bottom: none;
    }
    .bookmark-item button {
      margin-left: 10px;
      background: var(--red-primary);
      color: #fff;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* -------------------------- */
    /* Mobile UI Styles           */
    /* -------------------------- */
    @media (max-width: 768px) {
      /* Hide the desktop sidebar */
      #sidebar {
        display: none;
      }
      /* Force reader to occupy full width */
      #reader {
        left: 0 !important;
      }
      /* Show the mobile bottom navigation bar */
      #mobileNavBar {
        display: flex;
      }
    }
    /* Mobile bottom navigation bar */
    #mobileNavBar {
      display: none; /* shown via media query */
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      justify-content: space-around;
      padding: 10px 0;
      z-index: 1200;
    }
    #mobileNavBar button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    /* Mobile Menu Modal (for additional controls) */
    #mobileMenu {
      display: none; /* hidden by default */
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      padding: 20px;
      z-index: 1300;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
    }
    #mobileMenu .mobileMenuContent {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    #mobileMenu button {
      background: #eee;
      border: none;
      padding: 10px;
      border-radius: 4px;
      font-size: 18px;
      cursor: pointer;
    }
    /* On-screen mobile page turning buttons (left/right sides) */
    .mobile-nav {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 50%;
      color: #fff;
      font-size: 24px;
      z-index: 1200;
      display: none;
    }
    #mobileNavLeft { left: 10px; }
    #mobileNavRight { right: 10px; }
    @media (max-width: 768px) {
      .mobile-nav {
        display: block;
      }
    }
  </style>
</head>
<body>
  <!-- Library View: Shown on startup -->
  <div id="library">
    <h1>Select a Book</h1>
    <div id="libraryList"></div>
  </div>
  
  <!-- Desktop Sidebar (UI Tab) -->
  <div id="sidebar" class="retracted">
    <button id="sidebarToggle"><i class="fas fa-chevron-right"></i></button>
    <div id="sidebarContent">
      <button id="prev" title="Previous Page"><i class="fas fa-chevron-left"></i></button>
      <button id="next" title="Next Page"><i class="fas fa-chevron-right"></i></button>
      <button id="toggleTheme" title="Toggle Theme"><i class="fas fa-adjust"></i></button>
      <button id="toggleTOC" title="Toggle TOC"><i class="fas fa-bars"></i></button>
      <button id="downloadEPUB" title="Download EPUB"><i class="fas fa-download"></i></button>
      <button id="toggleFullscreen" title="Toggle Fullscreen"><i class="fas fa-expand"></i></button>
      <button id="decreaseFont" title="Decrease Text Size"><i class="fas fa-minus"></i></button>
      <button id="increaseFont" title="Increase Text Size"><i class="fas fa-plus"></i></button>
      <button id="addBookmark" title="Add Bookmark"><i class="fas fa-bookmark"></i></button>
      <button id="bookmarkManagerBtn" title="Bookmark Manager"><i class="fas fa-book-reader"></i></button>
      <button id="togglePageMode" title="Toggle Page Mode"><i class="fas fa-book-open"></i></button>
      <label for="fileInput" title="Upload EPUB"><i class="fas fa-upload"></i></label>
      <input type="file" id="fileInput" accept=".epub">
      <span id="pageInfo"></span>
    </div>
  </div>
  
  <!-- Mobile Bottom Navigation Bar -->
  <div id="mobileNavBar">
    <button id="mPrev" title="Previous Page"><i class="fas fa-chevron-left"></i></button>
    <button id="mTOC" title="Table of Contents"><i class="fas fa-book"></i></button>
    <button id="mMenu" title="Menu"><i class="fas fa-ellipsis-h"></i></button>
    <button id="mNext" title="Next Page"><i class="fas fa-chevron-right"></i></button>
  </div>
  
  <!-- Mobile Menu Modal (for additional controls) -->
  <div id="mobileMenu" class="hidden">
    <div class="mobileMenuContent">
      <button id="mToggleTheme" title="Toggle Theme"><i class="fas fa-adjust"></i></button>
      <button id="mDownloadEPUB" title="Download EPUB"><i class="fas fa-download"></i></button>
      <button id="mToggleFullscreen" title="Toggle Fullscreen"><i class="fas fa-expand"></i></button>
      <button id="mDecreaseFont" title="Decrease Font Size"><i class="fas fa-minus"></i></button>
      <button id="mIncreaseFont" title="Increase Font Size"><i class="fas fa-plus"></i></button>
      <button id="mAddBookmark" title="Add Bookmark"><i class="fas fa-bookmark"></i></button>
      <button id="mBookmarkManager" title="Bookmark Manager"><i class="fas fa-book-reader"></i></button>
      <button id="mTogglePageMode" title="Toggle Page Mode"><i class="fas fa-book-open"></i></button>
      <button id="mCloseMenu" title="Close Menu"><i class="fas fa-times"></i></button>
    </div>
  </div>
  
  <!-- On-screen Mobile Page Turning Buttons -->
  <div id="mobileNavLeft" class="mobile-nav"><i class="fas fa-chevron-left"></i></div>
  <div id="mobileNavRight" class="mobile-nav"><i class="fas fa-chevron-right"></i></div>
  
  <!-- TOC Sidebar -->
  <div id="toc"></div>
  
  <!-- Reader Container (hidden until a book is selected) -->
  <div id="reader" class="hidden"></div>
  
  <!-- Bookmark Manager Modal -->
  <div id="bookmarkManager" class="hidden">
    <div class="content">
      <h2>Bookmarks</h2>
      <ul id="bookmarkList"></ul>
      <button id="closeBookmarkManager">Close</button>
    </div>
  </div>
  
  <!-- -------------------------- -->
  <!-- JavaScript Section         -->
  <!-- -------------------------- -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // -------------------------- 
      // Library Books Data 
      // (Cover image will be extracted from within the EPUB)
      // -------------------------- 
      const libraryBooks = [
        { name: "LeverAction.epub", title: "Lever Action" }
        // Add additional books as needed.
      ];
      
      const libraryListEl = document.getElementById("libraryList");
      libraryBooks.forEach(book => {
        const bookItem = document.createElement("div");
        bookItem.className = "book-item";
        
        // Create image element for cover; use a transparent placeholder initially.
        const img = document.createElement("img");
        img.alt = book.title;
        img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
        bookItem.appendChild(img);
        
        const titleEl = document.createElement("div");
        titleEl.textContent = book.title;
        bookItem.appendChild(titleEl);
        
        // Load the EPUB and retrieve its cover from within the file.
        const epubBook = ePub(book.name);
        epubBook.loaded.metadata.then(() => {
          epubBook.coverUrl().then(function(url) {
            img.src = url;
          }).catch(function(err) {
            console.error("No cover found for", book.name, err);
          });
        }).catch(err => {
          console.error("Error loading EPUB", book.name, err);
        });
        
        bookItem.addEventListener("click", function() {
          startBook(book);
        });
        libraryListEl.appendChild(bookItem);
      });
      
      // -------------------------- 
      // Start a Book 
      // -------------------------- 
      function startBook(book) {
        document.getElementById("library").classList.add("hidden");
        document.getElementById("reader").classList.remove("hidden");
        loadBook(book.name, book.name);
        // On mobile, ensure the bottom navigation bar is visible.
        if (window.innerWidth <= 768) {
          document.getElementById("mobileNavBar").style.display = "flex";
        }
      }
      
      // -------------------------- 
      // Desktop Sidebar Toggle 
      // -------------------------- 
      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebarToggle");
      sidebarToggle.addEventListener("click", function() {
        if (sidebar.classList.contains("retracted")) {
          sidebar.classList.remove("retracted");
          sidebarToggle.innerHTML = '<i class="fas fa-chevron-left"></i>';
        } else {
          sidebar.classList.add("retracted");
          sidebarToggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
        }
        // Force a reflow of the EPUB rendition.
        setTimeout(() => {
          if (currentRendition) {
            currentRendition.resize();
          }
        }, 300);
      });
      
      // -------------------------- 
      // EPUB Reader Setup 
      // -------------------------- 
      let currentBook = null;
      let currentRendition = null;
      let currentFileName = "";
      let currentFontSize = 16; // in pixels
      let onePageMode = false;
      
      // Bookmark functions
      function addBookmark() {
        if (!currentRendition) return;
        let loc = currentRendition.currentLocation();
        if (!loc || !loc.start || !loc.start.cfi) return;
        let cfi = loc.start.cfi;
        let page = currentBook.locations ? currentBook.locations.locationFromCfi(cfi) : "Unknown";
        let bookmark = { cfi: cfi, label: "Page " + page };
        let key = "bookmarks-" + currentFileName;
        let bookmarks = JSON.parse(localStorage.getItem(key) || "[]");
        bookmarks.push(bookmark);
        localStorage.setItem(key, JSON.stringify(bookmarks));
        alert("Bookmark added at " + bookmark.label);
      }
      
      function loadBookmarks() {
        let key = "bookmarks-" + currentFileName;
        return JSON.parse(localStorage.getItem(key) || "[]");
      }
      
      function updateBookmarkList() {
        let bookmarks = loadBookmarks();
        let listEl = document.getElementById("bookmarkList");
        listEl.innerHTML = "";
        if (bookmarks.length === 0) {
          let li = document.createElement("li");
          li.textContent = "No bookmarks added.";
          listEl.appendChild(li);
          return;
        }
        bookmarks.forEach((bm, index) => {
          let li = document.createElement("li");
          li.classList.add("bookmark-item");
          let span = document.createElement("span");
          span.textContent = bm.label;
          span.style.cursor = "pointer";
          span.addEventListener("click", () => {
            currentRendition.display(bm.cfi);
            hideBookmarkManager();
          });
          let delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.addEventListener("click", () => { removeBookmark(index); });
          li.appendChild(span);
          li.appendChild(delBtn);
          listEl.appendChild(li);
        });
      }
      
      function removeBookmark(index) {
        let key = "bookmarks-" + currentFileName;
        let bookmarks = loadBookmarks();
        bookmarks.splice(index, 1);
        localStorage.setItem(key, JSON.stringify(bookmarks));
        updateBookmarkList();
      }
      
      function showBookmarkManager() {
        updateBookmarkList();
        document.getElementById("bookmarkManager").classList.remove("hidden");
      }
      
      function hideBookmarkManager() {
        document.getElementById("bookmarkManager").classList.add("hidden");
      }
      
      document.getElementById("closeBookmarkManager").addEventListener("click", function() {
        hideBookmarkManager();
      });
      
      // Main book loading function
      function loadBook(source, fileName) {
        if (currentRendition) {
          currentRendition.destroy();
          currentRendition = null;
          document.getElementById("reader").innerHTML = "";
        }
        currentFileName = fileName;
        currentBook = ePub(source);
        
        // Set reader background immediately based on theme
        if (document.documentElement.classList.contains("dark")) {
          document.getElementById("reader").style.backgroundColor = "#1e1e1e";
        } else {
          document.getElementById("reader").style.backgroundColor = "#fff";
        }
        
        let renderOptions = { width: "100%", height: "100%" };
        if (window.innerWidth <= 768 || onePageMode) {
          renderOptions.spread = "none";
        }
        
        currentRendition = currentBook.renderTo("reader", renderOptions);
        
        if (onePageMode || window.innerWidth <= 768) {
          document.getElementById("reader").classList.add("one-page");
          setTimeout(scaleOnePageContent, 300);
        } else {
          document.getElementById("reader").classList.remove("one-page");
        }
        
        currentRendition.themes.fontSize(currentFontSize + "px");
        
        currentRendition.themes.register("dark", {
          "body": { "background": "#1e1e1e", "color": "#f5f5f5" },
          "p": { "color": "#f5f5f5" },
          "h1, h2, h3, h4, h5, h6": { "color": "#f5f5f5" }
        });
        
        if (document.documentElement.classList.contains("dark")) {
          currentRendition.themes.select("dark");
        } else {
          currentRendition.themes.select("default");
        }
        
        const savedLocation = localStorage.getItem("epub-location-" + fileName);
        currentRendition.display(savedLocation || undefined);
        
        currentRendition.on("relocated", function(location) {
          localStorage.setItem("epub-location-" + fileName, location.start.cfi);
          if (currentBook.locations && currentBook.locations.total) {
            let currentPage = currentBook.locations.locationFromCfi(location.start.cfi);
            document.getElementById("pageInfo").textContent = "Page " + currentPage + " of " + currentBook.locations.total;
          }
        });
        
        currentBook.loaded.navigation.then(function(navigation) {
          let tocElement = document.getElementById("toc");
          tocElement.innerHTML = "";
          let ul = document.createElement("ul");
          navigation.toc.forEach(function(chapter) {
            let li = document.createElement("li");
            let a = document.createElement("a");
            a.textContent = chapter.label;
            a.href = chapter.href;
            a.addEventListener("click", function(e) {
              e.preventDefault();
              currentRendition.display(chapter.href);
              if (window.innerWidth <= 768) { hideTOC(); }
            });
            li.appendChild(a);
            ul.appendChild(li);
          });
          tocElement.appendChild(ul);
        });
        
        currentBook.ready.then(function() {
          return currentBook.locations.generate(1600);
        }).then(function() {
          const currentLocation = currentRendition.currentLocation();
          if (currentLocation && currentBook.locations && currentBook.locations.total) {
            let currentPage = currentBook.locations.locationFromCfi(currentLocation.start.cfi);
            document.getElementById("pageInfo").textContent = "Page " + currentPage + " of " + currentBook.locations.total;
          }
        });
        
        currentRendition.hooks.content.register(function(contents, rendition) {
          const doc = contents.document;
          doc.body.setAttribute("tabindex", "0");
          doc.body.focus();
          doc.addEventListener("keydown", function(e) {
            if (e.key === "ArrowLeft") { rendition.prev(); }
            else if (e.key === "ArrowRight") { rendition.next(); }
          });
        });
      }
      
      function scaleOnePageContent() {
        const container = document.querySelector("#reader.one-page iframe, #reader.one-page .epub-view");
        if (!container) return;
        const baseWidth = 600;
        const baseHeight = 800;
        const viewportWidth = window.innerWidth * 0.9;
        const viewportHeight = window.innerHeight * 0.9;
        const scale = Math.min(viewportWidth / baseWidth, viewportHeight / baseHeight, 1);
        container.style.transform = "scale(" + scale + ")";
        container.style.transformOrigin = "center center";
      }
      
      // -------------------------- 
      // Global Event Listeners 
      // -------------------------- 
      document.getElementById("prev").addEventListener("click", function() {
        if (currentRendition) currentRendition.prev();
      });
      document.getElementById("next").addEventListener("click", function() {
        if (currentRendition) currentRendition.next();
      });
      
      // Use document.documentElement for theme toggling so light mode is preserved.
      document.getElementById("toggleTheme").addEventListener("click", function() {
        document.documentElement.classList.toggle("dark");
        if (document.documentElement.classList.contains("dark")) {
          localStorage.setItem("theme", "dark");
        } else {
          localStorage.setItem("theme", "light");
        }
        if (currentRendition) {
          currentRendition.themes.select(document.documentElement.classList.contains("dark") ? "dark" : "default");
        }
      });
      
      function showTOC() {
        let toc = document.getElementById("toc");
        toc.classList.add("visible");
      }
      function hideTOC() {
        let toc = document.getElementById("toc");
        toc.classList.remove("visible");
      }
      document.getElementById("toggleTOC").addEventListener("click", function() {
        let toc = document.getElementById("toc");
        if (toc.classList.contains("visible")) { hideTOC(); }
        else { showTOC(); }
      });
      
      document.getElementById("fileInput").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (file) { loadBook(file, file.name); }
      });
      
      document.getElementById("downloadEPUB").addEventListener("click", function() {
        if (typeof currentFileName === "string" && currentFileName === "LeverAction.epub") {
          var link = document.createElement("a");
          link.href = currentFileName;
          link.download = currentFileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else { alert("Download is only available for the default EPUB."); }
      });
      
      document.getElementById("toggleFullscreen").addEventListener("click", function() {
        let elem = document.documentElement;
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
          if (elem.requestFullscreen) { elem.requestFullscreen(); }
          else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }
          else { alert("Fullscreen mode is not supported on your device."); }
        } else {
          if (document.exitFullscreen) { document.exitFullscreen(); }
          else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
        }
      });
      
      document.getElementById("increaseFont").addEventListener("click", function() {
        currentFontSize += 2;
        if (currentRendition && currentRendition.themes) {
          currentRendition.themes.fontSize(currentFontSize + "px");
        }
      });
      document.getElementById("decreaseFont").addEventListener("click", function() {
        currentFontSize = Math.max(10, currentFontSize - 2);
        if (currentRendition && currentRendition.themes) {
          currentRendition.themes.fontSize(currentFontSize + "px");
        }
      });
      
      document.addEventListener("keydown", function(e) {
        if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
        if (e.key === "ArrowLeft") { if (currentRendition) currentRendition.prev(); }
        else if (e.key === "ArrowRight") { if (currentRendition) currentRendition.next(); }
      });
      
      // -------------------------- 
      // Mobile Bottom Navigation Bar Events 
      // -------------------------- 
      document.getElementById("mPrev").addEventListener("click", function() {
        if (currentRendition) currentRendition.prev();
      });
      document.getElementById("mNext").addEventListener("click", function() {
        if (currentRendition) currentRendition.next();
      });
      document.getElementById("mTOC").addEventListener("click", function() {
        let toc = document.getElementById("toc");
        if (toc.classList.contains("visible")) { hideTOC(); }
        else { showTOC(); }
      });
      document.getElementById("mMenu").addEventListener("click", function() {
        // Show the mobile menu modal overlay
        document.getElementById("mobileMenu").classList.remove("hidden");
        document.getElementById("mobileMenu").style.display = "block";
      });
      
      // Mobile Menu Modal Button Events
      document.getElementById("mToggleTheme").addEventListener("click", function() {
        document.documentElement.classList.toggle("dark");
        if (document.documentElement.classList.contains("dark")) {
          localStorage.setItem("theme", "dark");
        } else {
          localStorage.setItem("theme", "light");
        }
        if (currentRendition) {
          currentRendition.themes.select(document.documentElement.classList.contains("dark") ? "dark" : "default");
        }
      });
      document.getElementById("mDownloadEPUB").addEventListener("click", function() {
        if (typeof currentFileName === "string" && currentFileName === "LeverAction.epub") {
          var link = document.createElement("a");
          link.href = currentFileName;
          link.download = currentFileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else { alert("Download is only available for the default EPUB."); }
      });
      document.getElementById("mToggleFullscreen").addEventListener("click", function() {
        let elem = document.documentElement;
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
          if (elem.requestFullscreen) { elem.requestFullscreen(); }
          else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }
          else { alert("Fullscreen mode is not supported on your device."); }
        } else {
          if (document.exitFullscreen) { document.exitFullscreen(); }
          else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
        }
      });
      document.getElementById("mIncreaseFont").addEventListener("click", function() {
        currentFontSize += 2;
        if (currentRendition && currentRendition.themes) {
          currentRendition.themes.fontSize(currentFontSize + "px");
        }
      });
      document.getElementById("mDecreaseFont").addEventListener("click", function() {
        currentFontSize = Math.max(10, currentFontSize - 2);
        if (currentRendition && currentRendition.themes) {
          currentRendition.themes.fontSize(currentFontSize + "px");
        }
      });
      document.getElementById("mAddBookmark").addEventListener("click", function() {
        addBookmark();
      });
      document.getElementById("mBookmarkManager").addEventListener("click", function() {
        showBookmarkManager();
      });
      document.getElementById("mTogglePageMode").addEventListener("click", function() {
        if (window.innerWidth < 769) {
          alert("Page mode toggle is available on desktop only.");
          return;
        }
        onePageMode = !onePageMode;
        const currentLocation = currentRendition.currentLocation();
        const cfi = currentLocation ? currentLocation.start.cfi : undefined;
        loadBook(currentFileName, currentFileName);
        if (cfi) { currentRendition.display(cfi); }
        if (onePageMode) {
          document.getElementById("reader").classList.add("one-page");
          setTimeout(scaleOnePageContent, 300);
        } else {
          document.getElementById("reader").classList.remove("one-page");
        }
        alert("Page mode is now set to " + (onePageMode ? "One Page (Centered)" : "Spread Mode") + ".");
      });
      document.getElementById("mCloseMenu").addEventListener("click", function() {
        // Hide the mobile menu overlay
        document.getElementById("mobileMenu").classList.add("hidden");
        document.getElementById("mobileMenu").style.display = "none";
      });
      
      // On-screen mobile page turning buttons (left/right)
      document.getElementById("mobileNavLeft").addEventListener("click", function() {
        if (currentRendition) currentRendition.prev();
      });
      document.getElementById("mobileNavRight").addEventListener("click", function() {
        if (currentRendition) currentRendition.next();
      });
      
      window.addEventListener("resize", function() {
        if (document.getElementById("reader").classList.contains("one-page")) {
          scaleOnePageContent();
        }
      });
    });
    
    // -------------------------- 
    // Service Worker Registration 
    // -------------------------- 
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js')
        .then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>
</body>
</html>