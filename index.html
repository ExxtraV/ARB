<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EPUB Reader (Faster Fade-In)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts & Font Awesome (optional) -->
  <link
    href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  />

  <!-- epub.js & JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
  <script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>

  <style>
    :root {
      --bg-light: #f5f7fa;
      --text-light: #333;
      --bg-dark: #1e1e1e;
      --text-dark: #f5f5f5;
      --accent-color: #4e54c8;
      --accent-light: #8f94fb;
    }
    html, body {
      margin: 0; 
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--bg-light);
      color: var(--text-light);
      transition: background-color 0.3s, color 0.3s;
      height: 100%;
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    .hidden { display: none !important; }

    /* Library Screen */
    #libraryScreen {
      padding: 2rem;
      text-align: center;
    }
    .book-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
    }
    .book-item {
      width: 150px;
      text-align: center;
      cursor: pointer;
    }
    .book-cover {
      width: 150px;
      height: 200px;
      object-fit: cover;
      border: 2px solid var(--accent-color);
      border-radius: 4px;
    }
    .book-title {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      font-weight: bold;
    }

    /* Reader Screen */
    #readerScreen {
      position: relative;
      width: 100%;
      height: 100vh;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      background: linear-gradient(90deg, var(--accent-color), var(--accent-light));
      color: #fff;
      padding: 0.5rem 1rem;
      z-index: 1000;
    }
    .toolbar button {
      background: rgba(255,255,255,0.2);
      border: none;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .toolbar button:hover {
      background: rgba(255,255,255,0.3);
    }

    /* The floating "Show UI" button */
    #showUIBtn {
      position: fixed;
      top: 5px; 
      left: 5px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      z-index: 3000; /* Above everything */
      display: none;
    }

    /* TOC */
    #toc {
      position: absolute;
      top: 3rem;
      left: 0;
      width: 250px;
      height: calc(100% - 3rem);
      background: #fff;
      color: #333;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      transition: transform 0.3s ease;
      z-index: 900;
    }
    body.dark #toc {
      background: #222;
      color: #f5f5f5;
    }
    #toc ul { list-style: none; margin: 0; padding: 1rem; }
    #toc li { margin-bottom: 0.5rem; }
    #toc a { text-decoration: none; color: inherit; }

    /* The Reader container for epub.js */
    #reader {
      position: absolute;
      top: 3rem;
      left: 0;
      width: 100%;
      height: calc(100% - 3rem);
      overflow: hidden;

      /* FASTER fade: 0.2s */
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }

    /* Modal for bookmarks */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      color: #333;
      padding: 1rem;
      border-radius: 6px;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
    }
    body.dark .modal-content {
      background: #2e2e2e;
      color: #f5f5f5;
    }

    /* Mobile / small screens */
    @media (max-width: 768px) {
      #toc {
        width: 100%;
        transform: translateY(-100%);
      }
    }
  </style>
</head>
<body>
  <!-- LIBRARY SCREEN -->
  <div id="libraryScreen">
    <h1>My EPUB Library</h1>
    <div id="bookList" class="book-list"></div>
  </div>

  <!-- READER SCREEN -->
  <div id="readerScreen" class="hidden">
    <!-- Toolbar -->
    <div id="toolbar" class="toolbar">
      <button id="prevPage" title="Prev Page"><i class="fas fa-chevron-left"></i></button>
      <button id="nextPage" title="Next Page"><i class="fas fa-chevron-right"></i></button>
      <span id="pageInfo" style="margin: 0 1rem;">Page ? of ?</span>

      <button id="toggleTOC" title="Toggle TOC"><i class="fas fa-bars"></i></button>
      <button id="toggleTheme" title="Toggle Theme"><i class="fas fa-adjust"></i></button>

      <button id="fontDecrease" title="Decrease Font"><i class="fas fa-minus"></i></button>
      <button id="fontIncrease" title="Increase Font"><i class="fas fa-plus"></i></button>

      <button id="addBookmark" title="Add Bookmark"><i class="fas fa-bookmark"></i></button>
      <button id="bookmarkManagerBtn" title="Manage Bookmarks"><i class="fas fa-book-reader"></i></button>

      <button id="downloadEPUB" title="Download EPUB"><i class="fas fa-download"></i></button>
      <button id="toggleFullscreen" title="Fullscreen"><i class="fas fa-expand"></i></button>

      <!-- Hide UI -->
      <button id="hideUIBtn" title="Hide UI"><i class="fas fa-eye-slash"></i></button>

      <!-- Back to library -->
      <button id="backToLibrary" title="Back"><i class="fas fa-arrow-left"></i></button>
    </div>

    <!-- Show UI button when hidden -->
    <div id="showUIBtn"><i class="fas fa-eye"></i></div>

    <!-- TOC -->
    <div id="toc" class="hidden"></div>

    <!-- Reader container -->
    <div id="reader"></div>
  </div>

  <!-- Bookmark Manager -->
  <div id="bookmarkManager" class="modal hidden">
    <div class="modal-content">
      <h2>Bookmarks</h2>
      <ul id="bookmarkList"></ul>
      <button id="closeBookmarkManager">Close</button>
    </div>
  </div>

  <script>
  /**********************************************************************
   * script.js (inlined)
   * ADDED: Mobile redirect logic at the start of DOMContentLoaded
   **********************************************************************/

  let currentBook = null;
  let rendition = null;
  let currentFile = "";
  let currentTheme = "light"; // or "dark"
  let currentFontSize = 16;

  // Example library data
  const libraryData = [
    { title: "Lever Action (Default)", filePath: "LeverAction.epub" },
    { title: "Sample Book", filePath: "SampleBook.epub" }
  ];

  document.addEventListener("DOMContentLoaded", async () => {
    // 1) MOBILE REDIRECTION:
    // If user is on a mobile device, redirect to mobile.html
    if (/Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
      window.location.href = "mobile.html";
      return; // don't continue
    }

    // 2) If not mobile, proceed with normal desktop logic
    // Restore theme
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.body.classList.add("dark");
      currentTheme = "dark";
    }

    // Restore font
    const savedFont = localStorage.getItem("fontSize");
    if (savedFont) {
      const parsed = parseInt(savedFont, 10);
      if (!isNaN(parsed)) currentFontSize = parsed;
    }

    // Initialize your library (desktop UI)
    await initLibrary();
  });

  async function initLibrary() {
    const libScreen = document.getElementById("libraryScreen");
    const readerScreen = document.getElementById("readerScreen");
    const bookList = document.getElementById("bookList");

    libScreen.classList.remove("hidden");
    readerScreen.classList.add("hidden");
    bookList.innerHTML = "";

    for (let entry of libraryData) {
      const item = document.createElement("div");
      item.className = "book-item";

      const img = document.createElement("img");
      img.className = "book-cover";
      img.src = "https://placehold.co/150x200?text=No+Cover";

      const title = document.createElement("div");
      title.className = "book-title";
      title.textContent = entry.title;

      item.appendChild(img);
      item.appendChild(title);
      bookList.appendChild(item);

      // Attempt real cover
      try {
        const b = ePub(entry.filePath);
        await b.ready;
        const c = await b.loaded.cover;
        if (c) img.src = c;
      } catch(e) {
        console.warn("Cover load error:", e);
      }

      item.addEventListener("click", () => {
        openBook(entry.filePath, currentTheme);
      });
    }
  }

  async function openBook(filePath, theme, cfi=null) {
    currentFile = filePath;
    currentTheme = theme;

    const libScreen = document.getElementById("libraryScreen");
    const readerScreen = document.getElementById("readerScreen");
    libScreen.classList.add("hidden");
    readerScreen.classList.remove("hidden");

    if (rendition) {
      rendition.destroy();
      rendition = null;
    }

    currentBook = ePub(filePath);
    rendition = currentBook.renderTo("reader", {
      width: "100%",
      height: "100%",
      manager: "default",
      flow: "paginated"
    });

    // Opacity = 0 for #reader by default; we'll fade in after load
    const readerEl = document.getElementById("reader");
    readerEl.style.opacity = "0";

    // Register theme definitions
    rendition.themes.register("light", {
      body: { background: "#ffffff", color: "#000000" }
    });
    rendition.themes.register("dark", {
      body: { background: "#1e1e1e", color: "#f5f5f5" }
    });

    rendition.themes.select(theme);
    rendition.themes.fontSize(currentFontSize + "px");

    // If no cfi, restore from localStorage
    if (!cfi) {
      const savedLoc = localStorage.getItem(`loc-${filePath}`);
      cfi = savedLoc || null;
    }
    await rendition.display(cfi);

    await currentBook.ready;
    await currentBook.locations.generate(1024);

    rendition.on("relocated", (location) => {
      if (location?.start?.cfi) {
        localStorage.setItem(`loc-${filePath}`, location.start.cfi);
        updatePageInfo(location);
      }
    });

    // Force arrow keys each chapter
    rendition.on("rendered", () => {
      attachChapterKeys();
      focusEPUB();
    });

    // Click for page nav if no selection
    rendition.on("click", (ev) => {
      const sel = window.getSelection()?.toString().trim();
      const frameSel = rendition.getRange()?.toString().trim();
      if (sel || frameSel) return;
      const bounds = ev.target.getBoundingClientRect();
      const x = ev.clientX - bounds.left;
      if (x < bounds.width / 2) rendition.prev();
      else rendition.next();
    });

    attachChapterKeys();

    // FADE IN: Just 50ms delay, then let the CSS do a 0.2s fade
    setTimeout(() => {
      readerEl.style.opacity = "1";
    }, 50);
  }

  function attachChapterKeys() {
    if (!rendition) return;
    rendition.getContents().forEach((contents) => {
      const doc = contents.document;
      if (!doc) return;
      doc.body.setAttribute("tabindex", "0");
      doc.body.addEventListener("click", () => doc.body.focus());
      doc.body.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") rendition.prev();
        else if (e.key === "ArrowRight") rendition.next();
      });
    });
  }

  function focusEPUB() {
    const contents = rendition?.getContents();
    if (!contents?.length) return;
    const doc = contents[0].document;
    if (!doc) return;
    doc.body.focus();
  }

  function updatePageInfo(location) {
    const pageInfoEl = document.getElementById("pageInfo");
    if (!currentBook?.locations) {
      pageInfoEl.textContent = `Loc: ${location.start.cfi}`;
      return;
    }
    const currentPage = currentBook.locations.locationFromCfi(location.start.cfi);
    const total = currentBook.locations.total;
    if (currentPage != null && total) {
      pageInfoEl.textContent = `Page ${currentPage} of ${total}`;
    } else {
      pageInfoEl.textContent = "Loading pages...";
    }
  }

  function buildTOC() {
    if (!currentBook?.navigation) return;
    const tocEl = document.getElementById("toc");
    tocEl.innerHTML = "";
    currentBook.loaded.navigation.then((nav) => {
      const ul = document.createElement("ul");
      nav.toc.forEach((chapter) => {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.textContent = chapter.label;
        a.href = "#";
        a.onclick = (e) => {
          e.preventDefault();
          rendition.display(chapter.href);
          if (window.innerWidth < 768) toggleTOC(true);
        };
        li.appendChild(a);
        ul.appendChild(li);
      });
      tocEl.appendChild(ul);
    });
  }

  function toggleTOC(forceHide=false) {
    const tocEl = document.getElementById("toc");
    if (forceHide) {
      tocEl.classList.add("hidden");
      return;
    }
    tocEl.classList.toggle("hidden");
    if (window.innerWidth < 768) {
      if (!tocEl.classList.contains("hidden")) {
        tocEl.style.transform = "translateY(0)";
      } else {
        tocEl.style.transform = "translateY(-100%)";
      }
    }
  }

  function addBookmark() {
    if (!rendition) return;
    const loc = rendition.currentLocation();
    if (!loc?.start?.cfi) return;
    const cfi = loc.start.cfi;
    const pageIndex = currentBook.locations.locationFromCfi(cfi);
    const label = (pageIndex != null) ? `Page ${pageIndex}` : `CFI: ${cfi}`;

    const key = "bookmarks-" + currentFile;
    let bookmarks = JSON.parse(localStorage.getItem(key) || "[]");
    bookmarks.push({ cfi, label });
    localStorage.setItem(key, JSON.stringify(bookmarks));
    alert(`Bookmark added at ${label}`);
  }
  function showBookmarkManager() {
    document.getElementById("bookmarkManager").classList.remove("hidden");
    updateBookmarkList();
  }
  function hideBookmarkManager() {
    document.getElementById("bookmarkManager").classList.add("hidden");
  }
  function updateBookmarkList() {
    const list = document.getElementById("bookmarkList");
    list.innerHTML = "";
    const key = "bookmarks-" + currentFile;
    const bookmarks = JSON.parse(localStorage.getItem(key) || "[]");
    if (!bookmarks.length) {
      const li = document.createElement("li");
      li.textContent = "No bookmarks yet.";
      list.appendChild(li);
      return;
    }
    bookmarks.forEach((bm, idx) => {
      const li = document.createElement("li");
      li.textContent = bm.label;
      li.style.cursor = "pointer";
      li.addEventListener("click", () => {
        rendition.display(bm.cfi);
        hideBookmarkManager();
      });
      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.style.marginLeft = "1rem";
      delBtn.onclick = (e) => {
        e.stopPropagation();
        bookmarks.splice(idx, 1);
        localStorage.setItem(key, JSON.stringify(bookmarks));
        updateBookmarkList();
      };
      li.appendChild(delBtn);
      list.appendChild(li);
    });
  }

  function downloadEPUB() {
    if (!currentFile) {
      alert("No book is open.");
      return;
    }
    try {
      const link = document.createElement("a");
      link.href = currentFile;
      link.download = currentFile.split("/").pop() || "book.epub";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (err) {
      alert("Download failed: " + err);
    }
  }

  window.addEventListener("load", () => {
    // Prev/Next
    document.getElementById("prevPage").onclick = () => rendition?.prev();
    document.getElementById("nextPage").onclick = () => rendition?.next();

    // TOC
    document.getElementById("toggleTOC").onclick = () => {
      buildTOC();
      toggleTOC();
    };

    // Theme
    document.getElementById("toggleTheme").onclick = () => {
      const cfi = rendition?.currentLocation()?.start?.cfi || null;
      if (currentTheme === "light") {
        currentTheme = "dark";
        document.body.classList.add("dark");
        localStorage.setItem("theme", "dark");
      } else {
        currentTheme = "light";
        document.body.classList.remove("dark");
        localStorage.setItem("theme", "light");
      }
      if (rendition) {
        rendition.destroy();
        rendition = null;
      }
      openBook(currentFile, currentTheme, cfi);
    };

    // Font
    document.getElementById("fontIncrease").onclick = () => {
      currentFontSize = Math.min(48, currentFontSize + 2);
      localStorage.setItem("fontSize", currentFontSize);
      const cfi = rendition?.currentLocation()?.start?.cfi || null;
      if (rendition) { rendition.destroy(); rendition=null; }
      openBook(currentFile, currentTheme, cfi);
    };
    document.getElementById("fontDecrease").onclick = () => {
      currentFontSize = Math.max(10, currentFontSize - 2);
      localStorage.setItem("fontSize", currentFontSize);
      const cfi = rendition?.currentLocation()?.start?.cfi || null;
      if (rendition) { rendition.destroy(); rendition=null; }
      openBook(currentFile, currentTheme, cfi);
    };

    // Bookmarks
    document.getElementById("addBookmark").onclick = () => addBookmark();
    document.getElementById("bookmarkManagerBtn").onclick = () => showBookmarkManager();
    document.getElementById("closeBookmarkManager").onclick = () => hideBookmarkManager();

    // Download
    document.getElementById("downloadEPUB").onclick = () => downloadEPUB();

    // Fullscreen
    document.getElementById("toggleFullscreen").onclick = () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch((err) => {
          alert("Fullscreen error: " + err);
        });
      } else {
        document.exitFullscreen();
      }
    };

    // Hide UI
    document.getElementById("hideUIBtn").onclick = () => {
      document.getElementById("toolbar").classList.add("hidden");
      document.getElementById("showUIBtn").style.display = "block";
    };
    // Show UI
    document.getElementById("showUIBtn").onclick = () => {
      document.getElementById("toolbar").classList.remove("hidden");
      document.getElementById("showUIBtn").style.display = "none";
    };

    // Back to Library
    document.getElementById("backToLibrary").onclick = () => {
      if (rendition) {
        rendition.destroy();
        rendition = null;
      }
      initLibrary();
    };
  });

  // Global arrow keys when focus is outside ePub
  document.addEventListener("keydown", (e) => {
    if (!rendition) return;
    if (["INPUT","TEXTAREA"].includes(e.target.tagName)) return;
    if (e.key === "ArrowLeft") rendition.prev();
    else if (e.key === "ArrowRight") rendition.next();
  });
  </script>
</body>
</html>