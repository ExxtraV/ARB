<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EPUB Reader with Upload</title>
  <style>
    /* Base styles for light and dark themes */
    :root {
      --bg-color: #ffffff;
      --text-color: #000000;
    }
    .dark {
      --bg-color: #1e1e1e;
      --text-color: #f5f5f5;
    }
    body {
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: Arial, sans-serif;
    }
    /* Toolbar styling */
    .toolbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--bg-color);
      color: var(--text-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      z-index: 1000;
    }
    button {
      padding: 5px 10px;
      cursor: pointer;
    }
    /* Hide the actual file input and style its label instead */
    input[type="file"] {
      display: none;
    }
    label[for="fileInput"] {
      padding: 5px 10px;
      background: #007BFF;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Reader container */
    #reader {
      margin-top: 60px; /* space for the toolbar */
      height: calc(100vh - 60px);
      overflow: auto;
    }
  </style>
</head>
<body>
  <!-- Toolbar with navigation, dark mode toggle, and upload control -->
  <div class="toolbar">
    <button id="prev">Previous</button>
    <button id="next">Next</button>
    <button id="toggleTheme">Toggle Theme</button>
    <label for="fileInput">Upload EPUB</label>
    <input type="file" id="fileInput" accept=".epub">
  </div>
  
  <!-- Container where the EPUB will be rendered -->
  <div id="reader"></div>
  
  <!-- Include JSZip (for archived EPUB files) and epub.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
  
  <script>
    // Global variables for tracking the current book and rendition
    let currentBook = null;
    let currentRendition = null;
    let currentFileName = "";

    /**
     * loadBook(source, fileName)
     *   - source: either a URL string (for the default file) or a File object (for uploads).
     *   - fileName: Identifier used for progress saving.
     */
    function loadBook(source, fileName) {
      // Clean up any previously loaded book
      if (currentRendition) {
        currentRendition.destroy();
        currentRendition = null;
        document.getElementById("reader").innerHTML = "";
      }
      
      currentFileName = fileName;
      // Pass the source (URL or File) directly to ePub
      currentBook = ePub(source);
      
      // Render the book into the #reader element
      currentRendition = currentBook.renderTo("reader", {
        width: "100%",
        height: "100%"
      });
      
      // Register a dark theme for EPUB content
      currentRendition.themes.register("dark", {
        "body": {
          "background": "#1e1e1e",
          "color": "#f5f5f5"
        },
        "p": {
          "color": "#f5f5f5"
        },
        "h1, h2, h3, h4, h5, h6": {
          "color": "#f5f5f5"
        }
      });
      
      // Apply the current outer page theme to the EPUB content
      if (document.body.classList.contains("dark")) {
        currentRendition.themes.select("dark");
      } else {
        currentRendition.themes.select("default");
      }
      
      // Load saved progress for this file (if any)
      const savedLocation = localStorage.getItem("epub-location-" + fileName);
      currentRendition.display(savedLocation || undefined);
      
      // Listen for location changes to save progress
      currentRendition.on("relocated", function(location) {
        localStorage.setItem("epub-location-" + fileName, location.start.cfi);
        console.log("Progress saved at:", location.start.cfi);
      });
    }
    
    // Load the default book "test.epub" on page load.
    // Ensure that test.epub is in the same folder as this HTML file.
    loadBook("test.epub", "test.epub");
    
    // Navigation button event listeners
    document.getElementById("prev").addEventListener("click", function(){
      if (currentRendition) currentRendition.prev();
    });
    document.getElementById("next").addEventListener("click", function(){
      if (currentRendition) currentRendition.next();
    });
    
    // Dark mode toggle event listener
    document.getElementById("toggleTheme").addEventListener("click", function(){
      document.body.classList.toggle("dark");
      if (currentRendition) {
        if (document.body.classList.contains("dark")) {
          currentRendition.themes.select("dark");
        } else {
          currentRendition.themes.select("default");
        }
      }
    });
    
    // File upload event listener
    document.getElementById("fileInput").addEventListener("change", function(e){
      const file = e.target.files[0];
      if (file) {
        // Instead of creating a Blob URL, pass the File object directly
        loadBook(file, file.name);
      }
    });
  </script>
</body>
</html>